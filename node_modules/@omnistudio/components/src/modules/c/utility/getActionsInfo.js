/*************************************************************************
 *
 * VLOCITY, INC. CONFIDENTIAL
 * __________________
 *
 *  [2014] - [2020] Vlocity, Inc.
 *  All Rights Reserved.
 *
 * NOTICE:  All information contained herein is, and remains
 * the property of Vlocity, Inc. and its suppliers,
 * if any. The intellectual and technical concepts contained
 * herein are proprietary to Vlocity, Inc. and its suppliers and may be
 * covered by U.S. and Foreign Patents, patents in process, and are
 * protected by trade secret or copyright law. Dissemination of this
 * information and reproduction, modification or reverse-engineering
 * of this material, is prohibited unless prior written permission
 * is obtained from Vlocity, Inc.
 *
 * Build: v234.0.0
 */
import { getActionsInfo } from "c/salesforceUtils";
import { namespace } from "./namespace";
let pendingActions = [];
let pendingActionList = [];
function getAllActions(disableCache = false) {
  /**
   * getActionsInfo will retrieve all 'active' vlocity actions just once.
   * Subsequent calls will get actions from the cached data unless the 'ignoreCache' flag is set
   */
  /** If disableCache is true donot get actions in sessionStorage */
  var cachedActions =
    sessionStorage.getItem("vlocity.allActions") && !disableCache
      ? JSON.parse(sessionStorage.getItem("vlocity.allActions"))
      : null;
  if (cachedActions != null) {
    return new Promise(function (resolve) {
      resolve(cachedActions);
    });
  }

  // Create the deffered object
  return new Promise(function (resolve, reject) {
    if (getActionsInfo) {
      if (!pendingActions.length) {
        let promise = getActionsInfo().then(
          actions => {
            sessionStorage.setItem(
              "vlocity.allActions",
              JSON.stringify(actions)
            );
            cachedActions = actions;
            return cachedActions;
          },
          function (error) {
            console.error("getActionsInfo retrieval error:" + error);
            cachedActions = [];
            reject(new Error("getActionsInfo retrieval error: " + error));
          }
        );
        pendingActions.push(promise);
      }
      resolve(pendingActions[0]);
    }
  });
}

function getActions(disableCache = false) {
  return new Promise(function (resolve) {
    /** If disableCache is true donot get actions in sessionStorage */
    var cachedActionList =
      sessionStorage.getItem("vlocity.actionList") && !disableCache
        ? JSON.parse(sessionStorage.getItem("vlocity.actionList"))
        : null;
    if (!cachedActionList || !Object.keys(cachedActionList).length) {
      if (!pendingActionList.length) {
        let actionList = getAllActions(disableCache).then(
          function (actions) {
            let updatedCachedActionList = actions.reduce(function (obj, action) {
              let actionObj = Object.assign({}, action);
              actionObj[namespace + "Url__c"] =
                actionObj[namespace + "Url__c"] ||
                actionObj[namespace + "URL__c"];
              obj[action.Name] = Object.assign(
                {
                  displayName: action[namespace + "DisplayLabel__c"],
                  openMode:
                    action[namespace + "OpenUrlMode__c"] ||
                    action[namespace + "OpenURLMode__c"] ||
                    action.openUrlIn,
                  vlocityIcon: action[namespace + "VlocityIcon__c"]
                },
                actionObj
              );
              // Maintain the displayName and vlocityIcon as it's used in templates
              // as part of old getActions implemenetation
              //action.displayName = action[getNameSpacePrefix() + 'DisplayLabel__c'];
              //action.vlocityIcon = action[getNameSpacePrefix() + 'VlocityIcon__c'];
              return obj;
            }, {});
            sessionStorage.setItem(
              "vlocity.actionList",
              JSON.stringify(updatedCachedActionList)
            );
            return updatedCachedActionList;
          },
          function (err) {
            console.error("getActionsInfoAsMap error ", err);
            return err;
          }
        );
        pendingActionList.push(actionList);
      }
      resolve(pendingActionList[0]);
    } else {
      resolve(cachedActionList);
    }
  });
}
export { getActions, getAllActions };
