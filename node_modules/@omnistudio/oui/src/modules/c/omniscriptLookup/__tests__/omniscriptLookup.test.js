/*************************************************************************
 *
 * VLOCITY, INC. CONFIDENTIAL
 * __________________
 *
 *  [2014] - [2020] Vlocity, Inc.
 *  All Rights Reserved.
 *
 * NOTICE:  All information contained herein is, and remains
 * the property of Vlocity, Inc. and its suppliers,
 * if any. The intellectual and technical concepts contained
 * herein are proprietary to Vlocity, Inc. and its suppliers and may be
 * covered by U.S. and Foreign Patents, patents in process, and are
 * protected by trade secret or copyright law. Dissemination of this
 * information and reproduction, modification or reverse-engineering
 * of this material, is prohibited unless prior written permission
 * is obtained from Vlocity, Inc.
 *
 * Build: v234.0.0
 */
import { createElement } from 'lwc';
import OmniscriptLookup from 'c/omniscriptLookup';
import { delay } from 'c/asyncUtils';
import { getPicklistValues } from 'lightning/uiObjectInfoApi';
import { registerTestWireAdapter } from '@salesforce/sfdx-lwc-jest';

jest.mock('c/omniscriptActionUtils', () => ({
    OmniscriptActionCommonUtil: function() {
        return {
            executeAction: () =>
                Promise.resolve({
                    result: {
                        options: [
                            {
                                value: 'a',
                                name: '0014T00000ECyZ3QAL',
                            },
                            {
                                value: 'b',
                                name: '0014T000007vQMyQAM',
                            },
                            {
                                value: 'c',
                                name: '0015T000007vQMyQAX',
                            },
                        ],
                    },
                }),
        };
    },
}));

const mockData = {
    data: {
        controllerValues: {},
        defaultValue: null,
        url: '/services/data/v52.0/ui-api/object-info/Contact/picklist-values/0124T000000U9zKQAS/oui_dailylwc__Type__c',
        values: [
            {
                attributes: null,
                label: 'Licensed Agent',
                validFor: [],
                value: 'Licensed Agent',
            },
            {
                attributes: null,
                label: 'Broker',
                validFor: [],
                value: 'Broker',
            },
            {
                attributes: null,
                label: 'Associate Agent',
                validFor: [],
                value: 'Associate Agent',
            },
            {
                attributes: null,
                label: 'Managing Agent',
                validFor: [],
                value: 'Managing Agent',
            },
        ],
    },
};

const currentPageReferenceAdapter = registerTestWireAdapter(getPicklistValues);

describe('c-omniscript-lookup', () => {
    const mockGetRecord = require('./mocks/getRecord.json');
    const mockScriptHeaderDef = require('./mocks/scriptHeaderDef.json');

    let lookup = null;

    beforeEach(() => {
        lookup = createElement('c-omniscript-lookup', {
            is: OmniscriptLookup,
        });
        lookup.key = mockGetRecord.name;
        lookup.jsonDef = mockGetRecord;
        lookup.dataOmniKey = mockGetRecord.index;
        lookup.jsonData = null;
        lookup.layout = 'newport';
        lookup.scriptHeaderDef = mockScriptHeaderDef;
    });

    afterEach(() => {
        while (document.body.firstChild) {
            document.body.removeChild(document.body.firstChild);
        }
        lookup = null;
    });

    // eslint-disable-next-line @lwc/lwc/no-async-await
    it('should display number of options correctly after the mock data is emitted', async () => {
        lookup.layout = 'lightning';
        document.body.appendChild(lookup);
        currentPageReferenceAdapter.emit(mockData);

        const input = lookup.shadowRoot.querySelector('input');
        lookup.focus();

        const event = new CustomEvent('keyup');
        event.key = 'ArrowDown';
        input.dispatchEvent(event); // expand menu
        await delay(0);

        const options = lookup.shadowRoot.querySelectorAll('[role="option"]');
        expect(options.length).toBe(5); // includes --
    });

    // eslint-disable-next-line @lwc/lwc/no-async-await
    it('should prefill correctly with strings and objects', async () => {
        lookup.layout = 'lightning';
        document.body.appendChild(lookup);
        lookup.applyCallResp('prefill component', true, false);
        await delay(0);
        expect(lookup.reportValidity()).toBe(true);

        const inputString = lookup.shadowRoot.querySelector('input');
        expect(inputString.value).toBe('prefill component');

        lookup.applyCallResp(
            {
                value: 'a',
                name: '0014T00000ECyZ3QAL',
            },
            true,
            false,
        );
        await delay(0);
        expect(lookup.reportValidity()).toBe(true);

        const inputObject = lookup.shadowRoot.querySelector('input');
        expect(inputObject.value).toBe('a');
    });

    it('should render in lightning mode', () => {
        let jsonDefCopy = JSON.parse(JSON.stringify(mockGetRecord));
        jsonDefCopy.propSetMap.repeat = true;
        jsonDefCopy.propSetMap.required = true;
        lookup.jsonDef = jsonDefCopy;
        lookup.layout = 'lightning';
        document.body.appendChild(lookup);
        expect(lookup.shadowRoot.children).not.toHaveLength(0);
        expect(lookup.shadowRoot.querySelector('.slds-grid')).toBeTruthy();
    });

    it('should render in newport mode', () => {
        let jsonDefCopy = JSON.parse(JSON.stringify(mockGetRecord));
        jsonDefCopy.propSetMap.repeat = true;
        lookup.jsonDef = jsonDefCopy;
        lookup.layout = 'newport';
        document.body.appendChild(lookup);
        expect(lookup.shadowRoot.children).not.toHaveLength(0);
        expect(lookup.shadowRoot.querySelector('.nds-combobox_container')).toBeTruthy();
    });

    // eslint-disable-next-line @lwc/lwc/no-async-await
    it('should expand if the down arrow key is pressed while focused', async () => {
        document.body.appendChild(lookup);
        const input = lookup.shadowRoot.querySelector('input');
        lookup.focus();

        const event = new CustomEvent('keyup');
        event.key = 'ArrowDown';
        input.dispatchEvent(event); // expand menu
        await delay(0);

        const element = lookup.shadowRoot.querySelector('[aria-expanded]');
        const options = lookup.shadowRoot.querySelectorAll('[role="option"]');
        expect(options.length).toBe(4);
        expect(element.getAttribute('aria-expanded')).toBe('true');
    });

    // eslint-disable-next-line @lwc/lwc/no-async-await
    it('should set aria-activedescendant to the id of the highlighted option', async () => {
        document.body.appendChild(lookup);
        const input = lookup.shadowRoot.querySelector('input');
        lookup.focus();

        const event = new CustomEvent('keyup');
        event.key = 'ArrowDown';
        input.dispatchEvent(event); // expand menu
        await delay(0);

        input.dispatchEvent(event); // go to --
        input.dispatchEvent(event); // go to first option
        await delay(0);

        expect(input.getAttribute('aria-activedescendant')).toEqual(expect.stringContaining('option-1'));
    });

    // eslint-disable-next-line @lwc/lwc/no-async-await
    it('should collapse on blur', async () => {
        document.body.appendChild(lookup);
        const input = lookup.shadowRoot.querySelector('input');
        lookup.focus();

        const event = new CustomEvent('keyup');
        event.key = 'ArrowDown';
        input.dispatchEvent(event); // expand menu
        await delay(0);

        input.dispatchEvent(event); // go to --
        input.dispatchEvent(event); // go to first option
        input.dispatchEvent(new CustomEvent('blur'));
        await delay(0);

        const element = lookup.shadowRoot.querySelector('[aria-expanded]');
        expect(element.getAttribute('aria-expanded')).toBe('false');
        expect(input.getAttribute('aria-activedescendant')).toEqual(null);
    });

    it('should clear custom validity on focusout', () => {
        document.body.appendChild(lookup);

        lookup.applyCallResp('custom error', false, true);
        expect(lookup.reportValidity()).toBe(false);

        lookup.focus();
        expect(lookup.reportValidity()).toBe(false);

        const input = lookup.shadowRoot.querySelector('input');
        input.dispatchEvent(new CustomEvent('focusout', { bubbles: true }));
        expect(lookup.reportValidity()).toBe(true);
    });

    // eslint-disable-next-line @lwc/lwc/no-async-await
    it('should set value after clearing custom validity', async () => {
        document.body.appendChild(lookup);
        lookup.applyCallResp('custom error', false, true);
        lookup.focus();

        const input = lookup.shadowRoot.querySelector('input');
        lookup.focus();

        const arrowDown = new CustomEvent('keyup');
        arrowDown.key = 'ArrowDown';
        const arrowUp = new CustomEvent('keyup');
        arrowUp.key = 'ArrowUp';
        const escape = new CustomEvent('keyup');
        escape.key = 'Escape';

        input.dispatchEvent(arrowDown); // expand menu
        await delay(0);

        input.dispatchEvent(arrowDown); // go to --
        input.dispatchEvent(arrowDown); // go to first option
        await delay(0);

        input.dispatchEvent(arrowUp); // go to --
        input.dispatchEvent(escape); // close
        await delay(0);

        const element = lookup.shadowRoot.querySelector('[aria-expanded]');
        expect(element.getAttribute('aria-expanded')).toBe('false');

        input.dispatchEvent(arrowDown); // expand menu
        await delay(0);

        input.dispatchEvent(arrowDown); // go to --
        input.dispatchEvent(arrowDown); // go to first option
        await delay(0);

        // select first option
        const enter = new CustomEvent('keyup');
        enter.key = 'Enter';
        input.dispatchEvent(enter);
        await delay(0);

        return new Promise(resolve => {
            lookup.addEventListener('omniaggregate', event => {
                expect(event.detail.data).toBe('0014T00000ECyZ3QAL');
                resolve();
            });
            input.dispatchEvent(new CustomEvent('focusout', { bubbles: true }));
        });
    });

    it('should emit omnirepeat in Lightning mode when repeat button is clicked', () => {
        lookup.layout = 'lightning';
        let jsonDefCopy = JSON.parse(JSON.stringify(mockGetRecord));
        jsonDefCopy.propSetMap.repeat = true;
        lookup.jsonDef = jsonDefCopy;
        document.body.appendChild(lookup);
        const addButton = lookup.shadowRoot.querySelector('.omni-repeat-button-group > button');
        return new Promise(resolve => {
            lookup.addEventListener('omnirepeat', () => resolve());
            addButton.click();
        });
    });

    it('should emit omnirepeat in Newport mode when repeat button is clicked', () => {
        lookup.layout = 'newport';
        let jsonDefCopy = JSON.parse(JSON.stringify(mockGetRecord));
        jsonDefCopy.propSetMap.repeat = true;
        lookup.jsonDef = jsonDefCopy;
        document.body.appendChild(lookup);
        const addButton = lookup.shadowRoot.querySelector('.omni-repeat-button-group > button');
        return new Promise(resolve => {
            lookup.addEventListener('omnirepeat', () => resolve());
            addButton.click();
        });
    });
});
